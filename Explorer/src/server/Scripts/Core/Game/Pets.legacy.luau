--[[⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠁⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠃⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⢨⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣿⣯⠁⠀⠉⠉⠙⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠀⠀⠀⠀⠈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⢠⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⠀⠀⠀⠀⠈⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀ ⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠈⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀ ⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⣿⣿⣿⠙⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠇⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⣿⣿⣿⠀⠈⠛⢿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠃⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⢹⣿⣿⡀⠀⠀⠀⠈⠉⠙⠛⠛⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠘⣿⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⣵⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣄⠀⠀⠸⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠄⣩⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣄⡀⢻⣿⣿⣿⣿⣶⣤⣀⣀⡀⠀⠀⠀⣀⣀⣤⣶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
           By: @pggondim     
--]]


--------|     Setting     |--------

--------|     Library     |--------
local _L = require(game.ReplicatedStorage:WaitForChild("Framework"):WaitForChild("Library"))
while (not _L.Loaded) do  game:GetService("RunService").Heartbeat:Wait()  end

--------|    Reference    |--------

--------|    Variables    |--------

--------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------

_L.Network.Fired("Clear Inventory Notifications"):Connect(function(plyr)
	_L.Saving.Get(plyr).InventoryNotifications = 0
end)

_L.Network.Invoked("Lock Pet").OnInvoke = function(plyr, pets)
    for uid, locking in pairs(pets) do
        local pet, owner = _L.Pets.Get(uid)
        if pet and owner == plyr then
			pet.l = locking or false
			_L.Network.FireAll("Pet Update", plyr, pet)
        end     
    end
end

_L.Network.Invoked("Equip Pet").OnInvoke = function(plyr, uid)
	uid = tostring(uid)

	local save = _L.Saving.Get(plyr)
	if not (save) then
		return 
	end
	
	return _L.Pets.Equip(uid)
end

_L.Network.Invoked("Unequip Pet").OnInvoke = function(plyr, uid)
	uid = tostring(uid)

	local save = _L.Saving.Get(plyr)
	if not (save) then
		return 
	end

	return _L.Pets.Unequip(uid)
end

local function hasPerms(plyr)
	local rank = plyr:GetRankInGroup(3112828)

    if _L.Admins.IsAdmin(plyr) then
        return true
    else
        if rank == 5 then
            return true
        end
    end
    
    return false
end

local function isSigning(plyr, isSigned, name)
    if plyr then
        if isSigned then
            if name ~= plyr.Name then
                return false
            else 
                return hasPerms(plyr)
            end
        else
            if name ~= plyr.Name then
                return false
            else 
                return hasPerms(plyr)
            end
        end
    end
    
    return false
end

_L.Network.Invoked("Rename Pet").OnInvoke = function(plyr, uid, nk)
	uid =  tostring(uid)
	nk  =  tostring(nk)
	
	local save = _L.Saving.Get(plyr)
	if (not save) then
		return
	end
	
	local pet, owner = _L.Pets.Get(uid)
	
	if #nk >= 20 then
		return nil, "Name is too long. Try something shorter!"
	end
	
	local filtered
	local success,e = pcall(function()
		filtered = _L.TextService:FilterStringAsync(nk, plyr.UserId)
		filtered = filtered:GetNonChatStringForBroadcastAsync()
	end)

	if not success or not filtered then
		return nil, "Unable to filter your pet nickname. Try something else"
	end

	nk = tostring(filtered):sub(1,20)
	pet.nk = nk
	pet.snk = isSigning(plyr, pet.snk, nk)
	coroutine.wrap(function()
		_L.Network.FireAll("Pet Update", plyr, pet)
	end)()
	
	return true
end

_L.Network.Invoked("Unequip All Pets").OnInvoke = function(plyr)
	local save = _L.Saving.Get(plyr)
	if (not save) then
		return
	end
	
	local PetsEquipped = _L.Shared.IsHardcore and save.HardcorePetsEquipped or save.PetsEquipped
	
	for i, v in pairs(PetsEquipped) do
		if v.uid then
			_L.Pets.Unequip(tostring(v.uid))
		else
			_L.Pets.Unequip(tostring(v))
		end
	end
	
	return true
end

_L.Network.Invoked("Delete Several Pets").OnInvoke = function(plyr, pets)
	local save = _L.Saving.Get(plyr)
	if (not save) then
		return
	end
	
	for i, uid in ipairs(pets) do	
		pcall(function()
			_L.Pets.Delete(tostring(uid))
		end)
	end
	
	return true
end

_L.Signal.Invoked("Delete Several Pets").OnInvoke = function(plyr, pets)
    local save = _L.Saving.Get(plyr)
    if not save then
        return
    end

    for _, uid in ipairs(pets) do	
        _L.Pets.Delete(uid)
    end

    return true
end

--_L.Network.Invoked("Equip Best Pets").OnInvoke = function(plyr)
--	local save = _L.Saving.Get(plyr)
--	if (not save) then
--		return nil,"error"
--	end
--	
--	local pets = _L.Functions.CloneTable(save.Pets)
--	
--	table.sort(pets, function(new,old)
--		return old.s < new.s
--	end)
--	
--	local equipped = {}
--	
--	local canEquip = save.InfPetsEnabled and #save.Pets or #pets < _L.Shared.GetMaxEquippedSlots(save) + 1 and #save.Pets or _L.Shared.GetMaxEquippedSlots(save)
--	
--	for i = 1, canEquip do
--		local pet = pets[i]
--		if not pet then
--			break
--		end
--		
--		equipped[pet.uid] = pet
--	end	
--	
--	local PetsEquipped = _L.Pets.GetEquipped(plyr)
--	
--	for i, pet in ipairs(save.Pets) do
--		if pet.uid then
--			local dir = _L.Directory.Pets[tostring(pet.id)]
--			
--			if equipped[pet.uid] and (not dir.isGift) then
--				_L.Pets.Equip(pet.uid)
--			else
--				if _L.Pets.IsEquipped(plyr,pet.uid) then
--					_L.Pets.Unequip(pet.uid)
--				end
--			end
--		end
--	end
--	
--	return true
--end

function IsGameWorld(plr)
	local world = _L.Saving.Get(plr)
	if not world then
		return false
	end
	local world = _L.Shared.IsHardcore and world.Hardcore.World or world.World  
	if world ~= "Yeet" then
		return false
	end
	return true
end

_L.Network.Invoked("Equip Best Pets").OnInvoke = function(plr)
	local save = _L.Saving.Get(plr)
	if not save then
		return nil
	end
	
	local pets = table.clone(save.Pets)
	for i, v in ipairs(pets) do		
		local dir = _L.Directory.Pets[v.id]
		if dir then
			if dir.isGift then
				table.remove(pets, i)
			end
		end
	end 
	
	local maxSlots = _L.Shared.GetMaxEquippedSlots(save)
	if not maxSlots then
		return nil
	end
	
	local yeetPower
	if IsGameWorld(plr) then
		yeetPower = function(pet)
			return _L.Shared.GetYeetPower(pet, pets)
		end
	end 
	
	table.sort(pets, function(i, v)   
		local order = _L.Shared.PetOrderBest(i, v, nil, nil, nil, nil, yeetPower) or -1
		return (order < 0)==true --invalid order function for sorting
	end)
	
	local equippedPets = {}
	if save.InfPetsEnabled or #pets < maxSlots + 1 then
		maxSlots = #pets
	end	  
	
	for i = 1, maxSlots do
		local pet = pets[i]
		if not pet then
			break
		end

		equippedPets[pet.uid] = pet
	end	
	
	for index, pet in pairs(save.Pets) do
		if pet.uid then
			local dir = _L.Directory.Pets[pet.id]
			if equippedPets[pet.uid] and not dir.isGift then
				_L.Pets.Equip(pet.uid)
			elseif _L.Pets.IsEquipped(plr, pet.uid) then
				_L.Pets.Unequip(pet.uid)
			end
		end
	end	
	
	return true
end

_L.Network.Fired("Set Riding Pet"):Connect(function(plyr, uid)
	local save = _L.Saving.Get(plyr)
	if not save then
		return
	end
	
	if save.Settings.MountingTitanics ~= 1 then
		return
	end
	
    if uid == nil then
        _L.Network.FireAll("Set Riding Pet", plyr, nil)
    end
    
    local pet, owner = _L.Pets.Get(uid)
    if owner ~= plyr then
        return
    end
    
    local dir = _L.Directory.Pets[pet.id]
    if not dir or not dir.titanic then
        return     
    end
    
    _L.Network.FireAll("Set Riding Pet", plyr, pet.uid)
end)


---

local RNG = Random.new()
_L.Signal.Fired("Player Added"):Connect(function(player)
	coroutine.wrap(function()
		while wait(10) do
			
			if not player or not player.Parent then
				break
			end
			
			local save = _L.Saving.Get(player)

			if save then
				local pets = {}
				for i,v in pairs(save.Pets) do
					local dir = _L.Directory.Pets[tostring(v.id)]
					if dir and not dir.huge and not dir.titanic then
						table.insert(pets, _L.Functions.CloneTable(v))
					end
				end
				
				table.sort(pets, function(i, v)
					return v.s < i.s
				end)
				
				local bestStat = pets[1] and pets[1].s and pets[1].s or 1
				
				task.spawn(function()
					for i, v in pairs(save.Pets) do
						if v and (v.uid and v.s) then	
							---
							--local E = v.r and "Rainbow" or v.g and "Gold" or "Default"
							local Type = "Default"
							if v.r then
								Type = "Rainbow"
							elseif v.g then
								Type = "Golden"
							end
							--
							if _L.Shared.HasPower(v, "Titanic") then
								v.s = math.floor(bestStat * _L.Shared.TitanicMult[Type])
							elseif _L.Shared.HasPower(v, "Best Friend") then
								v.s = math.floor(bestStat * _L.Shared.BestFriendMult[Type])
							elseif _L.Shared.HasPower(v, "Companion", 1) then
								v.s = math.floor(bestStat * 0.5)  						
							elseif _L.Shared.HasPower(v, "Companion", 2) then
								v.s = math.floor(bestStat * 0.6)  						
							elseif _L.Shared.HasPower(v, "Companion", 3) then
								v.s = math.floor(bestStat * 0.75)  						
							end
						end
					end
				end)
            end
            
			task.spawn(function()
				if not save or not save.Pets then
					return
				end
				
                for i, v in pairs(save.Pets) do
                    if v.uid then
                        local _, owner = _L.Pets.Get(v.uid)
                        if _L.Pets.IsEquipped(owner, v.uid) and _L.Shared.HasPower(v, "Glittering") and owner == player then
                            local allEquippedPets = {}
                            for i, v in pairs(save.Pets) do
                                if v.uid and _L.Pets.IsEquipped(owner, v.uid) then
                                    table.insert(allEquippedPets, v.uid)
                                end
                            end
                            
                            local petPosition = _L.Network.Invoke("Get Pet Positions", player, allEquippedPets)
                            if type(petPosition) == "table" and petPosition[v.uid] and typeof(petPosition[v.uid]) == "Vector3" then
                                _L.Orbs.Add(player, petPosition[v.uid] or player.Character.HumanoidRootPart, "Diamonds", RNG:NextInteger(10, 30), 25)
                            end
                        end
                    end
                end
			end)
		end
	end)()
end)

---

local petDB = _L.DataStoreService:GetOrderedDataStore("PetDataBase" .. _L.Settings.StatsVersion)
local petData = {}
local petDataM = {}

local function organize()
    local o = {}
    
    for i, v in pairs(petData) do
        o[tostring(v.key)] = tonumber(v.value)
    end
    
    petDataM = o
end

local function refresh()
    local data = nil
    local success, err = pcall(function()
        data = petDB:GetSortedAsync(false, 100):GetCurrentPage()
    end)
    
    if success and data ~= nil then
        petData = data
        organize()
    end
end

coroutine.wrap(function()
    task.spawn(function()
        while not petData do
            refresh()
            wait(2)
        end
    end)
    
    task.spawn(function()
        local tracking = {}
        local dev = {}
        local saving = {}
        
        _L.Signal.Fired("Track Pet"):Connect(function(plyr, pet, uid)
            local save = _L.Saving.Get(plyr)
            if save then
                if not tracking[plyr.UserId] then
                    tracking[plyr.UserId] = {}
                end
                
                if _L.Functions.SearchArray(dev, uid) then
                    return
                end
                
                table.insert(dev, uid)
                table.insert(tracking[plyr.UserId], tostring(pet))
            end
        end)
        
        local function set(plyr)
            if tracking[plyr.UserId] and not saving[plyr.UserId] then
                saving[plyr.UserId] = true
                
                local cache = {}
                for i, v in pairs(tracking[plyr.UserId]) do
                    if cache[v] then
                        cache[v] = cache[v] + 1
                    else
                        cache[v] = 1
                    end
                end
                
                for i, v in pairs(cache) do
                    local success, err = pcall(function()
                        petDB:IncrementAsync(i, v)
                    end)
                    
                    if not success then
                        _L.Heartbeat(3) 
                        
                        local success, err = pcall(function()
                            petDB:IncrementAsync(i, v)
                        end)
                    end
                end
            end
        end
        
        game.Players.PlayerRemoving:Connect(function(...)
            set(...)
        end)
        
        game:BindToClose(function()
            for i, v in pairs(game.Players:GetPlayers()) do
                coroutine.wrap(function()
                    set(v)
                end)()
            end
        end)
        
        while wait(120) do -- 2 mins
            for i, v in pairs(game.Players:GetPlayers()) do
                coroutine.wrap(function()
                    set(v)
                end)()
            end
            refresh()
        end
    end)
end)()

_L.Network.Invoked("Get Pet Rarity DB").OnInvoke = function()
    return petDataM
end

_L.Signal.Fired("Pet Added"):Connect(function(plyr, uid)	
    local pet, owner = _L.Pets.Get(plyr)
    if not pet or owner ~= plyr then
        return
    end
    
    _L.Modules.Pets.AddOwner(plyr.UserId, nil, uid)
end)

--[[ Last synced 9/21/2025 04:47                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Às vezes é mais fácil desistir mesmo ]]    --[[                                                                                                  ]]--